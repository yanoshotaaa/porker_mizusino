// --- FirebaseÂàùÊúüÂåñ ---
const firebaseConfig = {
  apiKey: "AIzaSyDk1TE3o4kmJ_rdYBtj91ja8kdRk_yAPsyY",
  authDomain: "porkerapp-445c0.firebaseapp.com",
  projectId: "porkerapp-445c0",
  storageBucket: "porkerapp-445c0.appspot.com",
  messagingSenderId: "377509457953",
  appId: "1:377509457953:web:c9ecdc54e6b1627d74f360",
  measurementId: "G-E38787RBJQ"
};
if (typeof firebase !== 'undefined') {
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
}

async function saveHandToFirestore(handData) {
  if (!db) return;
  try {
    await db.collection('poker_games').add(handData);
    console.log('Firestore„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
  } catch (e) {
    console.error('Firestore‰øùÂ≠ò„Ç®„É©„Éº:', e);
  }
}

// --- Ë®≠ÂÆöÂÄ§ ---
const PLAYER_NUM = 6;
const START_STACK = 100;
const SB = 1;
const BB = 3;
const ANTE = 3;
const POSITIONS = ["BTN", "SB", "BB", "UTG", "HJ", "CO"];

let state = null;
let dealerPosition = 0; // „Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥„ÅÆ‰ΩçÁΩÆÔºà0-5Ôºâ
let handNumber = 1; // „Éè„É≥„ÉâÁï™Âè∑
if (!window.allHistory) window.allHistory = [];
let startStacks = Array(PLAYER_NUM).fill(START_STACK - ANTE);

// --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }
function cardSuit(card) {
  if (!card) return '';
  if (card.endsWith("‚ô•")) return "suit-heart";
  if (card.endsWith("‚ô¶")) return "suit-diamond";
  if (card.endsWith("‚ô†")) return "suit-spade";
  if (card.endsWith("‚ô£")) return "suit-club";
  return '';
}

// „Éù„Ç∏„Ç∑„Éß„É≥Ââ≤„ÇäÂΩì„Å¶Èñ¢Êï∞
function assignPositions(dealerPos) {
  const positions = Array(PLAYER_NUM);
  
  // „Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥„Åã„ÇâÊôÇË®àÂõû„Çä„Åß„Éù„Ç∏„Ç∑„Éß„É≥Âêç„ÇíÂâ≤„ÇäÂΩì„Å¶
  // BTN -> SB -> BB -> UTG -> HJ -> CO
  for (let i = 0; i < PLAYER_NUM; i++) {
    const seatIndex = (dealerPos + i) % PLAYER_NUM;
    positions[seatIndex] = POSITIONS[i];
  }
  
  return positions;
}

// ‚ñº‚ñº‚ñº Ê•ïÂÜÜ„ÉÜ„Éº„Éñ„É´ÊèèÁîªÔºàÁõ¥Ëøë„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇÇË°®Á§∫Ôºâ ‚ñº‚ñº‚ñº
function renderEllipseTable(players, boardCards = [], actionLogs = [], currentPlayerIndex = -1) {
  const table = document.createElement("div");
  table.className = "table-ellipse";

  // „Çµ„Ç§„Ç∫„Çí„Ç¶„Ç£„É≥„Éâ„Ç¶Âü∫Ê∫ñ„Åß
  const w = Math.min(window.innerWidth * (window.innerWidth < 800 ? 0.96 : 0.65), 1100);
  const h = Math.max(w * (window.innerWidth < 800 ? 0.56 : 0.55), 180);

  table.style.width = w + "px";
  table.style.height = h + "px";

  const N = players.length;
  const cx = w / 2, cy = h / 2, rx = w * 0.42, ry = h * 0.44;
  const seatW = Math.max(w * 0.12, 62), seatH = Math.max(h * 0.14, 44);

  // „Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥„ÅÆË°®Á§∫ÊÉÖÂ†±„ÇíËøΩÂä†
  const dealerButtonInfo = document.createElement("div");
  dealerButtonInfo.style.position = "absolute";
  dealerButtonInfo.style.top = "10px";
  dealerButtonInfo.style.right = "10px";
  dealerButtonInfo.style.background = "#1976d2";
  dealerButtonInfo.style.color = "white";
  dealerButtonInfo.style.padding = "5px 10px";
  dealerButtonInfo.style.borderRadius = "8px";
  dealerButtonInfo.style.fontSize = "0.9em";
  dealerButtonInfo.style.fontWeight = "bold";
  dealerButtonInfo.style.zIndex = "20";
  dealerButtonInfo.innerHTML = `Hand #${handNumber}<br>Dealer: ${players[dealerPosition]?.name || 'Player'}`;
  table.appendChild(dealerButtonInfo);

  // Áõ¥Ëøë„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàÂÖ®‰Ωì„ÅÆactionLogs„Åã„ÇâÂêÑ„Éó„É¨„Ç§„É§„Éº„Åî„Å®ÊúÄÊñ∞„Å†„ÅëÊäΩÂá∫Ôºâ
  let latestActions = {};
  if (actionLogs && actionLogs.length) {
    for (let i = actionLogs.length - 1; i >= 0; i--) {
      const log = actionLogs[i];
      if (!(log.player in latestActions)) {
        latestActions[log.player] = log;
      }
    }
  }

  for (let i = 0; i < N; i++) {
    // „Éó„É¨„Ç§„É§„Éº0Ôºà„ÅÇ„Å™„ÅüÔºâ„ÅåÊâãÂâçÔºà‰∏ãÂÅ¥Ôºâ„Å´Êù•„Çã„Çà„ÅÜ„Å´Ë™øÊï¥
    // ËßíÂ∫¶„ÇíË™øÊï¥„Åó„Å¶„ÄÅ„Éó„É¨„Ç§„É§„Éº0„Çí‰∏ãÂÅ¥Ôºà90Â∫¶„ÅÆ‰ΩçÁΩÆÔºâ„Å´ÈÖçÁΩÆ
    const adjustedIndex = (i - 0 + N) % N; // „Éó„É¨„Ç§„É§„Éº0„ÇíÂü∫Ê∫ñ„Å´Ë™øÊï¥
    const angle = (Math.PI * 2 * adjustedIndex / N) + Math.PI / 2; // 90Â∫¶ÂõûËª¢„Åó„Å¶‰∏ãÂÅ¥„Çπ„Çø„Éº„Éà
    const x = cx + rx * Math.cos(angle) - seatW / 2;
    const y = cy + ry * Math.sin(angle) - seatH / 2;
    const p = players[i];
    const seat = document.createElement("div");
    
    // Â∫ßÂ∏≠„ÅÆ„ÇØ„É©„ÇπË®≠ÂÆö
    let seatClass = "seat";
    if (p.isUser) seatClass += " you";
    if (i === currentPlayerIndex && !state?.finished) seatClass += " current-player";
    if (p.folded) seatClass += " folded";
    if (i === dealerPosition) seatClass += " dealer"; // „Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥
    
    seat.className = seatClass;
    seat.style.left = `${x}px`;
    seat.style.top = `${y}px`;
    seat.style.width = seatW + "px";
    seat.style.height = seatH + "px";

    // ‚ñº Áõ¥Ëøë„Ç¢„ÇØ„Ç∑„Éß„É≥„ÉÜ„Ç≠„Çπ„Éà
    let actText = "";
    if (latestActions[p.name]) {
      const a = latestActions[p.name];
      if (a.action === "fold") actText = "„Éï„Ç©„Éº„É´„Éâ";
      else if (a.action === "call") actText = `„Ç≥„Éº„É´Ôºà${a.amount}Ôºâ`;
      else if (a.action === "check") actText = "„ÉÅ„Çß„ÉÉ„ÇØ";
      else if (a.action === "raise") actText = `„É¨„Ç§„Ç∫Ôºà${a.amount}Ôºâ`;
      else if (a.action === "bet") actText = `„Éô„ÉÉ„ÉàÔºà${a.amount}Ôºâ`;
      else actText = a.action;
    }

    // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
    const currentPlayerIndicator = i === currentPlayerIndex && !state?.finished ? 
      '<div style="color: #ff5722; font-weight: bold; font-size: 0.8em;">‚ñ∂ „Ç¢„ÇØ„Ç∑„Éß„É≥‰∏≠</div>' : '';

    // „Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº
    const dealerButtonIndicator = i === dealerPosition ? 
      '<div style="color: #1976d2; font-weight: bold; font-size: 0.7em;">üü° DEALER</div>' : '';

    seat.innerHTML = `
      <div class="player-name">${p.name}</div>
      <div class="player-pos">${p.position}</div>
      <div class="player-stack">Stack:${p.stack}</div>
      ${dealerButtonIndicator}
      ${currentPlayerIndicator}
      ${p.hand && p.hand.length === 2 ? `<div class="card-list">
        <span class="card ${cardSuit(p.hand[0])}">${p.hand[0]}</span>
        <span class="card ${cardSuit(p.hand[1])}">${p.hand[1]}</span>
      </div>` : ""}
      <div class="player-action-log">
        ${actText}
      </div>
    `;
    table.appendChild(seat);
  }

  // „Éú„Éº„Éâ„Ç´„Éº„Éâ‰∏≠Â§Æ
  const boardDiv = document.createElement("div");
  boardDiv.className = "table-board-cards";
  boardDiv.innerHTML = boardCards.map(c => `<span class="card ${cardSuit(c)}">${c}</span>`).join('');
  table.appendChild(boardDiv);

  return table;
}
// ‚ñ≤‚ñ≤‚ñ≤ Ê•ïÂÜÜ„ÉÜ„Éº„Éñ„É´ÊèèÁîª ‚ñ≤‚ñ≤‚ñ≤

// --- „Éá„ÉÉ„Ç≠ÔºÜ„Ç´„Éº„Éâ ---
function makeDeck() {
  const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
  const ranks = ["2","3","4","5","6","7","8","9","T","J","Q","K","A"];
  let cards = [];
  for (let s of suits) for (let r of ranks) cards.push(r+s);
  shuffle(cards);
  return cards;
}

function makePlayers() {
  let arr = [];
  const currentPositions = assignPositions(dealerPosition);
  
  for (let i = 0; i < PLAYER_NUM; i++) {
    arr.push({
      name: i === 0 ? "„ÅÇ„Å™„Åü" : `CPU${i}`,
      position: currentPositions[i],
      stack: START_STACK,
      bet: 0,
      hand: [],
      folded: false,
      isUser: i === 0,
      actions: [],
      hasActedThisRound: false,
    });
  }
  return arr;
}

function cloneStateForHistory(state) {
  return JSON.parse(JSON.stringify({
    gameNumber: (window.allHistory?.length || 0) + 1,
    handNumber: handNumber,
    dealerPosition: dealerPosition,
    timestamp: new Date().toISOString(),
    gameResult: {
      stage: state.stage,
      pot: state.pot,
      board: [...state.board],
      finished: state.finished
    },
    players: state.players.map((p, i) => ({
      name: p.name,
      position: p.position,
      isUser: p.isUser,
      startingStack: state.handStartStacks[i], // „Éè„É≥„ÉâÈñãÂßãÊôÇ„ÅÆ„Çπ„Çø„ÉÉ„ÇØ
      finalStack: p.stack,
      stackChange: p.stack - state.handStartStacks[i], // Ê≠£Á¢∫„Å™ÂèéÊîØ
      hand: p.hand,
      folded: p.folded,
      totalBet: p.bet,
      actions: [...p.actions]
    })),
    actionLog: [...state.actionLog],
    detailedActions: state.actionLog.map(action => ({
      ...action,
      timestamp: new Date().toISOString(),
      potAfterAction: state.pot
    }))
  }));
}

// --- ÂàùÊúüÂåñ ---
function initGame() {
  state = {
    deck: makeDeck(),
    board: [],
    pot: 0,
    players: makePlayers(),
    stage: "„Éó„É™„Éï„É≠„ÉÉ„Éó",
    currentPlayer: 0,
    minBet: BB,
    currentBet: BB,
    lastAggressor: null,
    actionLog: [],
    history: [],
    finished: false,
    showdownResult: null
  };
  
  // ÂêÑ„Éè„É≥„ÉâÈñãÂßãÊôÇ„ÅÆ„Çπ„Çø„ÉÉ„ÇØÔºà„Ç¢„É≥„ÉÜ„Ç£„Éª„Éñ„É©„Ç§„É≥„ÉâÊéßÈô§ÂâçÔºâ„ÇíË®òÈå≤
  const handStartStacks = state.players.map(p => p.stack);

  // „Ç¢„É≥„ÉÜ„Ç£„ÇíÂæ¥Âèé
  for (let i = 0; i < PLAYER_NUM; i++) {
    state.players[i].stack -= ANTE;
    state.pot += ANTE;
  }

  // SB„Å®BB„ÅÆ‰ΩçÁΩÆ„ÇíÂãïÁöÑ„Å´Ê±∫ÂÆö
  const sbPosition = (dealerPosition + 1) % PLAYER_NUM;
  const bbPosition = (dealerPosition + 2) % PLAYER_NUM;
  const utgPosition = (dealerPosition + 3) % PLAYER_NUM;

  // SB„Å®BB„ÇíÂæ¥Âèé
  state.players[sbPosition].stack -= SB;
  state.players[sbPosition].bet = SB;
  state.pot += SB;
  
  state.players[bbPosition].stack -= BB;
  state.players[bbPosition].bet = BB;
  state.pot += BB;
  
  state.currentBet = BB;
  state.minBet = BB;

  // „Éè„É≥„Éâ„ÇíÈÖç„Çã
  for (let p of state.players) {
    p.hand = [state.deck.pop(), state.deck.pop()];
    p.folded = false;
    p.bet = p.bet || 0;
    p.actions = [];
    p.hasActedThisRound = false;
  }
  
  // „Éó„É™„Éï„É≠„ÉÉ„Éó„Åß„ÅØSB„Å®BB„ÅØÊó¢„Å´„Ç¢„ÇØ„Ç∑„Éß„É≥„Åó„Åü„Å®„Åø„Å™„Åô
  state.players[sbPosition].hasActedThisRound = true;
  state.players[bbPosition].hasActedThisRound = true;
  
  // UTG„Åã„Çâ„Ç¢„ÇØ„Ç∑„Éß„É≥„Çπ„Çø„Éº„ÉàÔºàBB„ÅÆÊ¨°„ÅÆ„Éó„É¨„Ç§„É§„ÉºÔºâ
  state.currentPlayer = utgPosition;
  
  state.actionLog = [];
  state.history = [];
  state.finished = false;
  state.showdownResult = null;
  
  // „Åì„ÅÆ„Éè„É≥„ÉâÈñãÂßãÊôÇ„ÅÆ„Çπ„Çø„ÉÉ„ÇØ„Çí‰øùÂ≠ò
  state.handStartStacks = handStartStacks;
  
  renderGame();
}

// --- Ê¨°„ÅÆ„Éè„É≥„Éâ„ÇíÈñãÂßã ---
function nextHand() {
  // „Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥„ÇíÊôÇË®àÂõû„Çä„Å´ÁßªÂãï
  dealerPosition = (dealerPosition + 1) % PLAYER_NUM;
  handNumber++;
  
  // Êñ∞„Åó„ÅÑ„Éè„É≥„Éâ„ÇíÈñãÂßã
  initGame();
}

// --- „Ç≤„Éº„É†ÁîªÈù¢ÊèèÁîª ---
function renderGame() {
  const root = document.getElementById("game-section");
  root.innerHTML = "";
  
  if (state.finished) {
    let winnerText = '';
    if (state.showdownResult) {
      winnerText += `<div style="margin:1em 0 0.7em 0; font-size:1.08em;"><b>„ÄêÂãùÊïóÁµêÊûú„Äë</b><br>`;
      for (const win of state.showdownResult.winners) {
        winnerText += `<b>${win.name}</b>Ôºà${win.position}Ôºâ<br>
          ÂΩπÔºö${win.handName} <span class="card-list">${win.hand.map(c=>`<span class="card ${cardSuit(c)}">${c}</span>`).join('')}</span>
          <br>Áç≤Âæó: ${state.showdownResult.winAmount}„ÉÅ„ÉÉ„Éó<br><br>`;
      }
      winnerText += `</div>`;
    }
    let profit = state.players[0].stack - state.handStartStacks[0];
    winnerText += `<b>„ÅÇ„Å™„Åü„ÅÆÂèéÊîØÔºö</b><span style="color:${profit>=0?'#1976d2':'#e53935'};">${profit>=0?'+':''}${profit}</span> „ÉÅ„ÉÉ„Éó<br>`;

    // „Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ„ÅØÂÖ®Âì°„ÅÆ„Éè„É≥„Éâ„ÇíË°®Á§∫
    root.appendChild(renderEllipseTable(state.players, state.board, state.actionLog));

    root.innerHTML += `
      <h2>„Éè„É≥„Éâ #${handNumber} ÁµÇ‰∫Ü</h2>
      ${winnerText}
      <button onclick="showHistory()">ÂØæÊà¶Â±•Ê≠¥„ÇíË¶ã„Çã</button>
      <button onclick="nextHand()">Ê¨°„ÅÆ„Éè„É≥„Éâ</button>
      <button onclick="initGame()">Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†</button>
    `;
    if (!state.loggedHistory) {
      window.allHistory.push({
        ...cloneStateForHistory(state),
        showdownResult: state.showdownResult,
        profit: profit,
        board: [...state.board]
      });
      // FirestoreÁî®„Éá„Éº„ÇøÊï¥ÂΩ¢
      const handData = {
        userId: "test_user", // ÂøÖË¶Å„Å´Âøú„Åò„Å¶„É¶„Éº„Ç∂„ÉºID„ÇíÂãïÁöÑ„Å´
        players: state.players.map(p => ({
          name: p.name,
          position: p.position,
          hand: p.hand,
          stack: p.stack,
          isUser: p.isUser
        })),
        board: [...state.board],
        pot: state.pot,
        stage: state.stage,
        isFinished: true,
        date: new Date(),
        additionalData: {}
      };
      saveHandToFirestore(handData);
      state.loggedHistory = true;
    }
    return;
  }

  // „Éó„É¨„Ç§ÁîªÈù¢ÔºöÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆ„Éè„É≥„Éâ„ÇíË°®Á§∫
  root.appendChild(renderEllipseTable(state.players, state.board, state.actionLog, state.currentPlayer));

  // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
  const currentPlayer = state.players[state.currentPlayer];
  const playerInfoDiv = document.createElement("div");
  playerInfoDiv.className = "game-info-panel";
  playerInfoDiv.innerHTML = `
    <b>„Éè„É≥„Éâ #${handNumber}</b> - „Éá„Ç£„Éº„É©„Éº: ${state.players[dealerPosition].name}<br>
    <b>ÁèæÂú®„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥:</b> ${currentPlayer.name} (${currentPlayer.position})<br>
    <b>ÁèæÂú®„ÅÆ„Éô„ÉÉ„Éà:</b> ${state.currentBet} „ÉÅ„ÉÉ„Éó<br>
    <b>„Éù„ÉÉ„Éà:</b> ${state.pot} „ÉÅ„ÉÉ„Éó<br>
    <b>„Çπ„ÉÜ„Éº„Ç∏:</b> ${state.stage}
  `;
  root.appendChild(playerInfoDiv);

  // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàÂÖ®„Éó„É¨„Ç§„É§„ÉºÁî®Ôºâ
  if (!currentPlayer.folded && !state.finished) {
    const actionDiv = document.createElement("div");
    actionDiv.style.margin = "18px 0 7px 0";
    
    const callAmount = state.currentBet - currentPlayer.bet;
    const playerTypeText = currentPlayer.isUser ? "„ÅÇ„Å™„Åü" : `${currentPlayer.name}ÔºàCPUÔºâ`;
    
    // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÇíÊ±∫ÂÆö
    let actionButtons = '';
    
    if (callAmount > 0) {
      // „Ç≥„Éº„É´/„É¨„Ç§„Ç∫/„Éï„Ç©„Éº„É´„Éâ„ÅÆÁä∂Ê≥Å
      actionButtons = `
        <button onclick="playerAction('fold', ${state.currentPlayer})">„Éï„Ç©„Éº„É´„Éâ</button>
        <button onclick="playerAction('call', ${state.currentPlayer})">„Ç≥„Éº„É´Ôºà${callAmount}Ôºâ</button>
        <button onclick="playerAction('raise', ${state.currentPlayer})">„É¨„Ç§„Ç∫</button>
      `;
    } else {
      // „ÉÅ„Çß„ÉÉ„ÇØ/„Éô„ÉÉ„Éà/„Éï„Ç©„Éº„É´„Éâ„ÅÆÁä∂Ê≥Å
      actionButtons = `
        <button onclick="playerAction('fold', ${state.currentPlayer})">„Éï„Ç©„Éº„É´„Éâ</button>
        <button onclick="playerAction('check', ${state.currentPlayer})">„ÉÅ„Çß„ÉÉ„ÇØ</button>
        <button onclick="playerAction('bet', ${state.currentPlayer})">„Éô„ÉÉ„Éà</button>
      `;
    }
    
    actionDiv.innerHTML = `
      <b>${playerTypeText}„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû</b>
      <div class="action-list">
        ${actionButtons}
        ${!currentPlayer.isUser ? '<button onclick="cpuAutoAction()">CPUËá™Âãï„Ç¢„ÇØ„Ç∑„Éß„É≥</button>' : ''}
      </div>
    `;
    root.appendChild(actionDiv);
    
    // CPU„Éó„É¨„Ç§„É§„Éº„ÅÆÂ†¥Âêà„ÅÆËøΩÂä†ÊÉÖÂ†±
    if (!currentPlayer.isUser) {
      const cpuInfoDiv = document.createElement("div");
      cpuInfoDiv.className = "cpu-info-box";
      cpuInfoDiv.innerHTML = `
        <div class="cpu-hand">
          <b>ü§ñ ${currentPlayer.name}„ÅÆ„Éè„É≥„Éâ:</b> 
          <span class="card-list">
            <span class="card ${cardSuit(currentPlayer.hand[0])}">${currentPlayer.hand[0]}</span>
            <span class="card ${cardSuit(currentPlayer.hand[1])}">${currentPlayer.hand[1]}</span>
          </span>
        </div>
        <div class="cpu-tip">üí° „Åì„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÊâãÂãï„ÅßÊìç‰Ωú„Åô„Çã„Åã„ÄÅCPUËá™Âãï„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô</div>
      `;
      root.appendChild(cpuInfoDiv);
    }
  }
  
  window.scrollTo({top:0, behavior:'smooth'});
}

// --- Áµ±‰∏Ä„Åï„Çå„Åü„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜÈñ¢Êï∞ ---
function playerAction(actionType, playerIndex) {
  let player = state.players[playerIndex];
  
  if (actionType === "fold") {
    player.folded = true;
    player.hasActedThisRound = true;
    logAction(player, "fold", 0);
    nextPlayer();
  } else if (actionType === "check") {
    // „ÉÅ„Çß„ÉÉ„ÇØÔºöËøΩÂä†„Éô„ÉÉ„Éà„Å™„Åó
    player.hasActedThisRound = true;
    logAction(player, "check", 0);
    nextPlayer();
  } else if (actionType === "call") {
    const callAmount = state.currentBet - player.bet;
    if (callAmount > player.stack) {
      // „Ç™„Éº„É´„Ç§„É≥
      const allInAmount = player.stack;
      state.pot += allInAmount;
      player.bet += allInAmount;
      player.stack = 0;
      logAction(player, "call", allInAmount);
    } else {
      player.stack -= callAmount;
      player.bet += callAmount;
      state.pot += callAmount;
      logAction(player, "call", callAmount);
    }
    player.hasActedThisRound = true;
    nextPlayer();
  } else if (actionType === "bet") {
    let betAmount = prompt(`${player.name}„ÅÆ„Éô„ÉÉ„ÉàÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\nÔºà‰æã: ${BB}Ôºâ`);
    betAmount = parseInt(betAmount);
    
    if (isNaN(betAmount) || betAmount <= 0) {
      alert("ÁÑ°Âäπ„Å™ÈáëÈ°ç„Åß„Åô„ÄÇÊ≠£„ÅÆÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }
    
    if (betAmount > player.stack) {
      betAmount = player.stack; // „Ç™„Éº„É´„Ç§„É≥
      alert(`${player.name}„ÅØ„Ç™„Éº„É´„Ç§„É≥„Åó„Åæ„ÅôÔºà${betAmount}Ôºâ`);
    }
    
    player.stack -= betAmount;
    player.bet += betAmount;
    state.pot += betAmount;
    state.currentBet = betAmount;
    state.lastAggressor = playerIndex;
    player.hasActedThisRound = true;
    
    // „Éô„ÉÉ„Éà„Åó„ÅüÂ†¥Âêà„ÄÅ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅØÂÜçÂ∫¶„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåÂøÖË¶Å
    resetActionsAfterAggression(playerIndex);
    
    logAction(player, "bet", betAmount);
    nextPlayer();
  } else if (actionType === "raise") {
    let raiseTo = prompt(`${player.name}„ÅÆ„É¨„Ç§„Ç∫È°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\nÔºàÁèæÂú®„Éô„ÉÉ„Éà:${state.currentBet} ‰æã: ${state.currentBet + 6}Ôºâ`);
    raiseTo = parseInt(raiseTo);
    
    if (isNaN(raiseTo) || raiseTo <= state.currentBet) {
      alert("ÁÑ°Âäπ„Å™ÈáëÈ°ç„Åß„Åô„ÄÇÁèæÂú®„ÅÆ„Éô„ÉÉ„ÉàÈ°ç„Çà„ÇäÂ§ß„Åç„ÅÑÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }
    
    const maxRaise = player.stack + player.bet;
    if (raiseTo > maxRaise) {
      raiseTo = maxRaise; // „Ç™„Éº„É´„Ç§„É≥
      alert(`${player.name}„ÅØ„Ç™„Éº„É´„Ç§„É≥„Åó„Åæ„ÅôÔºà${raiseTo}Ôºâ`);
    }
    
    const pay = raiseTo - player.bet;
    player.stack -= pay;
    player.bet += pay;
    state.pot += pay;
    state.currentBet = raiseTo;
    state.lastAggressor = playerIndex;
    player.hasActedThisRound = true;
    
    // „É¨„Ç§„Ç∫„Åó„ÅüÂ†¥Âêà„ÄÅ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅØÂÜçÂ∫¶„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåÂøÖË¶Å
    resetActionsAfterAggression(playerIndex);
    
    logAction(player, "raise", pay);
    nextPlayer();
  }
}

// „É¨„Ç§„Ç∫/„Éô„ÉÉ„ÉàÂæå„Å´‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
function resetActionsAfterAggression(aggressorIndex) {
  for (let i = 0; i < state.players.length; i++) {
    if (i !== aggressorIndex && !state.players[i].folded) {
      state.players[i].hasActedThisRound = false;
    }
  }
}

function logAction(player, act, amount) {
  player.actions.push({ stage: state.stage, action: act, amount, stack: player.stack });
  state.actionLog.push({
    player: player.name,
    stage: state.stage,
    action: act,
    amount,
    stack: player.stack,
  });
}

// --- CPUËá™Âãï„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàÂæìÊù•„ÅÆÊ©üËÉΩ„Çí‰øùÊåÅÔºâ ---
async function cpuAutoAction() {
  let p = state.players[state.currentPlayer];
  if (p.folded) { 
    nextPlayer(); 
    return; 
  }
  
  // CPUÊÄùËÄÉ‰∏≠„ÅÆË°®Á§∫
  const actionButtons = document.querySelector('.action-list');
  if (actionButtons) {
    actionButtons.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ü§ñ CPUÊÄùËÄÉ‰∏≠...</div>';
  }
  
  await sleep(800 + Math.random() * 700);
  
  const callAmount = state.currentBet - p.bet;
  let act, pay = 0;
  
  // CPUÂà§Êñ≠„É≠„Ç∏„ÉÉ„ÇØ
  if (p.stack <= 0) { 
    act = callAmount > 0 ? "call" : "check"; 
    pay = 0; 
  } else if (callAmount > 15 && Math.random() < 0.55) { 
    act = "fold"; 
  } else if (Math.random() < 0.12 && p.stack > state.currentBet * 2) { 
    act = callAmount > 0 ? "raise" : "bet";
  } else { 
    act = callAmount > 0 ? "call" : "check";
  }

  if (act === "fold") {
    p.folded = true;
    p.hasActedThisRound = true;
    logAction(p, "fold", 0);
  } else if (act === "check") {
    p.hasActedThisRound = true;
    logAction(p, "check", 0);
  } else if (act === "call") {
    if (callAmount > p.stack) {
      const allInAmount = p.stack;
      state.pot += allInAmount;
      p.bet += allInAmount;
      p.stack = 0;
      logAction(p, "call", allInAmount);
    } else {
      p.stack -= callAmount;
      p.bet += callAmount;
      state.pot += callAmount;
      logAction(p, "call", callAmount);
    }
    p.hasActedThisRound = true;
  } else if (act === "bet") {
    let betAmount = 3 + Math.floor(Math.random() * 6);
    betAmount = Math.min(betAmount, p.stack);
    p.stack -= betAmount;
    p.bet += betAmount;
    state.pot += betAmount;
    state.currentBet = betAmount;
    state.lastAggressor = state.currentPlayer;
    p.hasActedThisRound = true;
    resetActionsAfterAggression(state.currentPlayer);
    logAction(p, "bet", betAmount);
  } else if (act === "raise") {
    let raiseTo = state.currentBet + 3 + Math.floor(Math.random() * 6);
    raiseTo = Math.min(raiseTo, p.stack + p.bet);
    const pay = raiseTo - p.bet;
    p.stack -= pay;
    p.bet += pay;
    state.pot += pay;
    state.currentBet = raiseTo;
    state.lastAggressor = state.currentPlayer;
    p.hasActedThisRound = true;
    resetActionsAfterAggression(state.currentPlayer);
    logAction(p, "raise", pay);
  }
  
  renderGame();
  await sleep(400 + Math.random() * 400);
  nextPlayer();
}

// --- ‰øÆÊ≠£„Åï„Çå„ÅüÊ¨°„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂá¶ÁêÜ ---
function nextPlayer() {
  // Áîü„Åç„Å¶„ÅÑ„Çã„Éó„É¨„Ç§„É§„Éº„ÇíÂèñÂæó
  let alivePlayers = state.players.filter(p => !p.folded);
  
  // 1‰∫∫„Åó„ÅãÊÆã„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç≤„Éº„É†ÁµÇ‰∫Ü
  if (alivePlayers.length === 1) {
    state.finished = true;
    const winner = alivePlayers[0];
    winner.stack += state.pot;
    renderGame();
    return;
  }

  // Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÊé¢„Åô
  do {
    state.currentPlayer = (state.currentPlayer + 1) % PLAYER_NUM;
  } while (state.players[state.currentPlayer].folded);

  // „Éô„ÉÉ„ÉÜ„Ç£„É≥„Ç∞„É©„Ç¶„É≥„ÉâÁµÇ‰∫ÜÊù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  if (isBettingRoundComplete()) {
    nextStage();
    return;
  }

  renderGame();
}

// „Éô„ÉÉ„ÉÜ„Ç£„É≥„Ç∞„É©„Ç¶„É≥„Éâ„ÅÆÂÆå‰∫ÜÂà§ÂÆö
function isBettingRoundComplete() {
  const alivePlayers = state.players.filter(p => !p.folded);
  
  // ÂÖ®Âì°„ÅåÂêå„ÅòÈ°ç„Çí„Éô„ÉÉ„Éà„Åó„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  const allSameBet = alivePlayers.every(p => p.bet === state.currentBet);
  
  // ÂÖ®Âì°„Åå„Åì„ÅÆ„É©„Ç¶„É≥„Éâ„Åß„Ç¢„ÇØ„Ç∑„Éß„É≥„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  const allHaveActed = alivePlayers.every(p => p.hasActedThisRound);
  
  // ‰∏°Êñπ„ÅÆÊù°‰ª∂„ÅåÊ∫Ä„Åü„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ„Åø„É©„Ç¶„É≥„ÉâÁµÇ‰∫Ü
  return allSameBet && allHaveActed;
}

// --- „Çπ„Éà„É™„Éº„ÉàÈÅ∑Áßª ---
function nextStage() {
  // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆ„Éô„ÉÉ„Éà„Å®„Ç¢„ÇØ„Ç∑„Éß„É≥Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
  for (let p of state.players) {
    p.bet = 0;
    p.hasActedThisRound = false;
  }

  if (state.stage === "„Éó„É™„Éï„É≠„ÉÉ„Éó") {
    state.board = [state.deck.pop(), state.deck.pop(), state.deck.pop()];
    state.stage = "„Éï„É≠„ÉÉ„Éó";
  } else if (state.stage === "„Éï„É≠„ÉÉ„Éó") {
    state.board.push(state.deck.pop());
    state.stage = "„Çø„Éº„É≥";
  } else if (state.stage === "„Çø„Éº„É≥") {
    state.board.push(state.deck.pop());
    state.stage = "„É™„Éê„Éº";
  } else if (state.stage === "„É™„Éê„Éº") {
    state.finished = true;
    for (let p of state.players) {
      if (!p.folded) p.showHand = true;
    }
    state.showdownResult = judgeWinners(state.players, state.board, state.pot);
    renderGame();
    return;
  }
  
  state.currentBet = 0;
  state.minBet = BB;
  state.lastAggressor = null;
  
  // „Éï„É≠„ÉÉ„Éó‰ª•Èôç„ÅØ„ÄÅSBÔºà„Éá„Ç£„Éº„É©„Éº„Éú„Çø„É≥„ÅÆÊ¨°„ÅÆ„Éó„É¨„Ç§„É§„ÉºÔºâ„Åã„ÇâÈñãÂßã
  const sbPosition = (dealerPosition + 1) % PLAYER_NUM;
  state.currentPlayer = sbPosition;
  
  // „Éï„Ç©„Éº„É´„Éâ„Åó„Å¶„ÅÑ„Å™„ÅÑÊúÄÂàù„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíË¶ã„Å§„Åë„Çã
  while (state.players[state.currentPlayer].folded) {
    state.currentPlayer = (state.currentPlayer + 1) % PLAYER_NUM;
  }
  
  renderGame();
}

// --- ÂØæÊà¶Â±•Ê≠¥Ôºà‰∏ÄË¶ßÔºâ ---
function showHistory() {
  document.getElementById("game-section").style.display = "none";
  document.getElementById("history-section").style.display = "block";
  document.getElementById("history-detail").style.display = "none";
  showAllHistory();
}
function showAllHistory() {
  let minProfit = Number(document.getElementById("min-profit")?.value || -9999);
  let maxProfit = Number(document.getElementById("max-profit")?.value || 9999);

  let list = window.allHistory || [];
  list = list.filter(h => h.profit >= minProfit && h.profit <= maxProfit);

  let html = "";
  if (!list.length) html = "<div style='color:#999'>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>";
  list.forEach((h, idx) => {
    html += `<div style="border-bottom:1px solid #ddd;padding:6px 0;">
      <b>„Éè„É≥„Éâ #${h.handNumber || idx+1}</b> („Éá„Ç£„Éº„É©„Éº: ${h.players[h.dealerPosition || 0]?.name || 'Player'})
      ÂèéÊîØÔºö<span style="color:${h.profit>=0?'#1976d2':'#e53935'};">${h.profit>=0?'+':''}${h.profit}</span> „ÉÅ„ÉÉ„Éó
      <button onclick="showSingleHistory(${idx})">Ë©≥Á¥∞</button>
    </div>`;
  });
  document.getElementById("history-list").innerHTML = html;
  document.getElementById("history-detail").style.display = "none";
}
function showSingleHistory(idx) {
  const h = window.allHistory[idx];
  let html = `<h3>„Éè„É≥„Éâ #${h.handNumber || idx+1} Ë©≥Á¥∞</h3>`;
  html += `<p><b>„Éá„Ç£„Éº„É©„Éº:</b> ${h.players[h.dealerPosition || 0]?.name || 'Player'} (Â∫ßÂ∏≠ ${(h.dealerPosition || 0) + 1})</p>`;
  
  // Â±•Ê≠¥ÁîªÈù¢„Åß„ÅØÂÖ®Âì°ÂàÜ„ÅÆ„Éè„É≥„ÉâË°®Á§∫
  html += renderEllipseTable(h.players, h.board, h.actionLog).outerHTML;

  // „Éù„Ç∏„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇíË°®Á§∫
  html += `<div style="margin: 15px 0; padding: 10px; background: #f5f5f5; border-radius: 8px;">`;
  html += `<b>„Éù„Ç∏„Ç∑„Éß„É≥ÈÖçÁΩÆ:</b><br>`;
  h.players.forEach((p, i) => {
    html += `${p.name}: ${p.position}${i === (h.dealerPosition || 0) ? ' (DEALER)' : ''}<br>`;
  });
  html += `</div>`;

  // „Éú„Éº„ÉâÈÄ≤Ë°åË°®Á§∫Ôºà„Çπ„Éà„É™„Éº„Éà„Åî„Å®Ôºâ
  const boardOnStreet = {
    "„Éó„É™„Éï„É≠„ÉÉ„Éó": [],
    "„Éï„É≠„ÉÉ„Éó": h.board.slice(0, 3),
    "„Çø„Éº„É≥": h.board.slice(0, 4),
    "„É™„Éê„Éº": h.board.slice(0, 5),
  };
  
  for (const stage of ["„Éó„É™„Éï„É≠„ÉÉ„Éó", "„Éï„É≠„ÉÉ„Éó", "„Çø„Éº„É≥", "„É™„Éê„Éº"]) {
    html += `<b>${stage}</b>`;
    html += ` <span class="card-list">`;
    boardOnStreet[stage].forEach(card => {
      html += `<span class="card ${cardSuit(card)}">${card}</span>`;
    });
    html += `</span><br>`;
    
    for (let p of h.players) {
      html += `<span class="player-name">${p.name} (${p.position})</span> `;
      if (p.hand && p.hand.length === 2) {
        html += `<span class="card-list">
          <span class="card ${cardSuit(p.hand[0])}">${p.hand[0]}</span>
          <span class="card ${cardSuit(p.hand[1])}">${p.hand[1]}</span>
        </span>`;
      }
      let acts = p.actions.filter(a => a.stage === stage).map(a =>
        `${a.action} (${a.amount})`
      ).join(" ‚Üí ");
      html += `„ÄÄ${acts}<br>`;
    }
    html += `<br>`;
  }
  
  if (h.showdownResult) {
    html += `<b>„ÄêÂãùÊïóÁµêÊûú„Äë</b><br>`;
    for (const win of h.showdownResult.winners) {
      html += `<b>${win.name}</b>Ôºà${win.position}Ôºâ<br>
        ÂΩπÔºö${win.handName} <span class="card-list">${win.hand.map(c=>`<span class="card ${cardSuit(c)}">${c}</span>`).join('')}</span>
        <br>Áç≤Âæó: ${h.showdownResult.winAmount}„ÉÅ„ÉÉ„Éó<br><br>`;
    }
  }
  
  html += `<b>„ÅÇ„Å™„Åü„ÅÆÂèéÊîØÔºö</b><span style="color:${h.profit>=0?'#1976d2':'#e53935'};">${h.profit>=0?'+':''}${h.profit}</span> „ÉÅ„ÉÉ„Éó<br>`;
  html += `<button onclick="showAllHistory()">‰∏ÄË¶ß„Å´Êàª„Çã</button>`;
  
  document.getElementById("history-detail").innerHTML = html;
  document.getElementById("history-detail").style.display = "";
}

// --- Êàª„Çã ---
document.getElementById("back-to-game-btn").onclick = () => {
  document.getElementById("history-section").style.display = "none";
  document.getElementById("game-section").style.display = "";
  renderGame();
};
document.getElementById("reset-btn").onclick = () => { 
  dealerPosition = 0; 
  handNumber = 1;
  // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çπ„Çø„ÉÉ„ÇØ„ÇíÂàùÊúüÂÄ§„Å´„É™„Çª„ÉÉ„Éà
  for (let i = 0; i < PLAYER_NUM; i++) {
    if (state && state.players[i]) {
      state.players[i].stack = START_STACK;
    }
  }
  initGame(); 
};
document.getElementById("show-history-btn").onclick = () => { showHistory(); };
document.getElementById("filter-btn").onclick = () => { showAllHistory(); };

initGame();

// --- ÂΩπË©ï‰æ° ---
function judgeWinners(players, board, pot) {
  const alive = players.filter(p => !p.folded);
  let scores = alive.map(p => {
    const allCards = [...p.hand, ...board];
    const evalResult = evaluateHandSimple(allCards);
    return {
      ...p,
      score: evalResult.score,
      handName: evalResult.handName,
      hand: evalResult.bestHand
    };
  });

  scores.sort((a, b) => b.score - a.score);
  const bestScore = scores[0].score;
  const winners = scores.filter(s => s.score === bestScore);
  const winAmount = Math.floor(pot / winners.length);

  return { winners, winAmount };
}
function evaluateHandSimple(cards) {
  let combs = k_combinations(cards, 5);
  let maxScore = 0, handName = "„Éè„Ç§„Ç´„Éº„Éâ", bestHand = [];
  for (let hand of combs) {
    let r = rank5(hand);
    if (r.score > maxScore) {
      maxScore = r.score;
      handName = r.handName;
      bestHand = hand.slice();
    }
  }
  return { score: maxScore, handName, bestHand };
}
function rank5(hand) {
  const order = ["„Éè„Ç§„Ç´„Éº„Éâ","„ÉØ„É≥„Éö„Ç¢","„ÉÑ„Éº„Éö„Ç¢","„Çπ„É™„Éº„Ç´„Éº„Éâ","„Çπ„Éà„É¨„Éº„Éà","„Éï„É©„ÉÉ„Ç∑„É•","„Éï„É´„Éè„Ç¶„Çπ","„Éï„Ç©„Éº„Ç´„Éº„Éâ","„Çπ„Éà„É¨„Éº„Éà„Éï„É©„ÉÉ„Ç∑„É•"];
  const ranks = "23456789TJQKA".split("");
  let vals = hand.map(c => ranks.indexOf(c[0])).sort((a,b)=>b-a);
  let suits = hand.map(c => c[1]);
  let counts = {};
  for (let v of vals) counts[v] = (counts[v]||0)+1;
  let uniq = Object.keys(counts).map(Number);
  let flush = suits.every(s=>s===suits[0]);
  let straight = uniq.length===5 && (uniq[0]-uniq[4]===4 || (uniq[0]===12 && uniq[1]===3 && uniq[4]===0));
  if (straight && flush)   return {score:9000+vals[0], handName:order[8]};
  if (Object.values(counts).includes(4)) return {score:8000+uniq.find(v=>counts[v]===4), handName:order[7]};
  if (Object.values(counts).includes(3) && Object.values(counts).includes(2)) return {score:7000+uniq.find(v=>counts[v]===3), handName:order[6]};
  if (flush)               return {score:6000+vals[0], handName:order[5]};
  if (straight)            return {score:5000+vals[0], handName:order[4]};
  if (Object.values(counts).includes(3)) return {score:4000+uniq.find(v=>counts[v]===3), handName:order[3]};
  if (Object.values(counts).filter(c=>c===2).length===2) return {score:3000+uniq[0], handName:order[2]};
  if (Object.values(counts).includes(2)) return {score:2000+uniq.find(v=>counts[v]===2), handName:order[1]};
  return {score:1000+vals[0], handName:order[0]};
}
function k_combinations(set, k) {
  if (k > set.length || k === 0) return [];
  if (k === set.length) return [set];
  if (k === 1) return set.map(e => [e]);
  let combs = [];
  for (let i = 0; i < set.length - k + 1; i++) {
    let head = set.slice(i, i+1);
    let tailcombs = k_combinations(set.slice(i+1), k-1);
    for (let comb of tailcombs) combs.push(head.concat(comb));
  }
  return combs;
}

// --- Â±•Ê≠¥„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÁî®Èñ¢Êï∞ ---
function exportHistoryAsJSON() {
  // „Çà„ÇäË©≥Á¥∞„ÅßÊï¥ÁêÜ„Åï„Çå„Åü„Éá„Éº„ÇøÊßãÈÄ†„Çí‰ΩúÊàê
  const detailedHistory = window.allHistory.map((game, index) => {
    // ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆË©≥Á¥∞Áµ±Ë®à„ÇíË®àÁÆó
    const playerStats = game.players.map(player => {
      const playerActions = game.actionLog.filter(log => log.player === player.name);
      const actionSummary = {
        folds: playerActions.filter(a => a.action === 'fold').length,
        calls: playerActions.filter(a => a.action === 'call').length,
        raises: playerActions.filter(a => a.action === 'raise').length,
        totalAmountBet: playerActions.reduce((sum, a) => sum + (a.amount || 0), 0)
      };

      return {
        playerInfo: {
          name: player.name,
          position: player.position,
          isUser: player.isUser
        },
        chipInfo: {
          startingStack: START_STACK,
          finalStack: player.stack,
          profit: player.stack - START_STACK,
          anteAndBlinds: ANTE + (player.position === 'SB' ? SB : 0) + (player.position === 'BB' ? BB : 0)
        },
        handInfo: {
          holeCards: player.hand,
          folded: player.folded,
          showedDown: !player.folded && game.stage === '„É™„Éê„Éº'
        },
        actionSummary: actionSummary,
        detailedActions: playerActions
      };
    });

    // „Ç≤„Éº„É†ÂÖ®‰Ωì„ÅÆÁµ±Ë®à
    const gameStats = {
      handNumber: game.handNumber || index + 1,
      dealerPosition: game.dealerPosition || 0,
      dealerName: game.players[game.dealerPosition || 0]?.name || 'Player',
      totalPot: game.pot,
      boardCards: game.board,
      finalStage: game.stage,
      numberOfPlayers: game.players.length,
      playersWhoFolded: game.players.filter(p => p.folded).length,
      playersInShowdown: game.players.filter(p => !p.folded).length
    };

    // ÂãùËÄÖÊÉÖÂ†±
    const winnerInfo = game.showdownResult ? {
      winners: game.showdownResult.winners.map(w => ({
        name: w.name,
        position: w.position,
        hand: w.hand,
        handRank: w.handName,
        amountWon: game.showdownResult.winAmount
      })),
      totalWinAmount: game.showdownResult.winAmount * game.showdownResult.winners.length
    } : null;

    return {
      gameInfo: {
        handNumber: game.handNumber || index + 1,
        dealerPosition: game.dealerPosition || 0,
        timestamp: game.timestamp || new Date().toISOString(),
        gameSettings: {
          playerCount: PLAYER_NUM,
          startingStack: START_STACK,
          smallBlind: SB,
          bigBlind: BB,
          ante: ANTE
        }
      },
      gameStats: gameStats,
      playerDetails: playerStats,
      winnerInfo: winnerInfo,
      chronologicalActions: game.actionLog.map((action, actionIndex) => ({
        actionNumber: actionIndex + 1,
        stage: action.stage,
        player: action.player,
        action: action.action,
        amount: action.amount || 0,
        stackAfterAction: action.stack,
        timestamp: new Date().toISOString()
      }))
    };
  });

  // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇËøΩÂä†
  const overallStats = {
    totalHands: detailedHistory.length,
    userStats: {
      totalProfit: detailedHistory.reduce((sum, game) => {
        const userPlayer = game.playerDetails.find(p => p.playerInfo.isUser);
        return sum + (userPlayer ? userPlayer.chipInfo.profit : 0);
      }, 0),
      handsWon: detailedHistory.filter(game => {
        return game.winnerInfo?.winners.some(w => w.name === '„ÅÇ„Å™„Åü');
      }).length,
      averageProfit: detailedHistory.length > 0 ? 
        detailedHistory.reduce((sum, game) => {
          const userPlayer = game.playerDetails.find(p => p.playerInfo.isUser);
          return sum + (userPlayer ? userPlayer.chipInfo.profit : 0);
        }, 0) / detailedHistory.length : 0
    },
    exportTimestamp: new Date().toISOString()
  };

  const exportData = {
    metadata: {
      appName: "„ÉÜ„Ç≠„Çµ„Çπ„Éõ„Éº„É´„Éá„É† „Éá„É¢Ôºà„Éù„Ç∏„Ç∑„Éß„É≥„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥ÂØæÂøúÔºâ",
      exportVersion: "3.0",
      exportDate: new Date().toISOString(),
      dataDescription: "„Éù„Éº„Ç´„Éº„Ç≤„Éº„É†„ÅÆË©≥Á¥∞Â±•Ê≠¥„Éá„Éº„ÇøÔºà„Éù„Ç∏„Ç∑„Éß„É≥„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„ÄÅ„Éó„É¨„Ç§„É§„Éº„Éè„É≥„Éâ„ÄÅ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÄÅ„ÉÅ„ÉÉ„ÉóÂ§âÂãï„ÇíÂê´„ÇÄÔºâ"
    },
    overallStats: overallStats,
    hands: detailedHistory
  };

  const dataStr = JSON.stringify(exportData, null, 2);
  const blob = new Blob([dataStr], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const fileName = `poker-detailed-history-${new Date().toISOString().slice(0,10)}.json`;

  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);

  // „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆå‰∫Ü„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
  alert(`Â±•Ê≠¥„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ\n„Éï„Ç°„Ç§„É´Âêç: ${fileName}\n\nÂê´„Åæ„Çå„ÇãÊÉÖÂ†±:\n‚Ä¢ „Éù„Ç∏„Ç∑„Éß„É≥„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±\n‚Ä¢ ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Éè„É≥„Éâ\n‚Ä¢ Ë©≥Á¥∞„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥Â±•Ê≠¥\n‚Ä¢ „ÉÅ„ÉÉ„Éó„ÅÆÂ§âÂãï\n‚Ä¢ „Ç≤„Éº„É†Áµ±Ë®à`);
}

// Ëµ∑ÂãïÊôÇ„Å´„Ç§„Éô„É≥„Éà„Çí„Éê„Ç§„É≥„Éâ
document.getElementById("export-history-btn").onclick = exportHistoryAsJSON;